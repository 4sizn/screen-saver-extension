---
phase: 01-foundation-&-activation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - wxt.config.ts
  - tsconfig.json
  - tailwind.config.ts
  - postcss.config.js
  - entrypoints/background.ts
  - lib/storage.ts
  - lib/messages.ts
autonomous: true

must_haves:
  truths:
    - "WXT project structure exists with React and TypeScript configured"
    - "Background service worker handles icon clicks and toggles activation state"
    - "Badge color changes between inactive (gray) and active (green) states"
    - "Activation triggers notification and sound feedback"
  artifacts:
    - path: "wxt.config.ts"
      provides: "Extension manifest configuration with cross-browser support"
      min_lines: 25
    - path: "entrypoints/background.ts"
      provides: "Service worker with icon click handler, badge management, notifications"
      exports: ["defineBackground"]
      min_lines: 80
    - path: "lib/storage.ts"
      provides: "Storage abstraction for activation state"
      exports: ["getActivationState", "setActivationState"]
    - path: "lib/messages.ts"
      provides: "Type-safe message protocol definitions"
      exports: ["MessageType", "ActivateMessage", "DeactivateMessage"]
  key_links:
    - from: "entrypoints/background.ts"
      to: "browser.action.onClicked"
      via: "event listener registration"
      pattern: "action\\.onClicked\\.addListener"
    - from: "entrypoints/background.ts"
      to: "browser.tabs.sendMessage"
      via: "message passing to content script"
      pattern: "tabs\\.sendMessage.*ACTIVATE|DEACTIVATE"
    - from: "entrypoints/background.ts"
      to: "browser.action.setBadgeBackgroundColor"
      via: "badge state updates"
      pattern: "setBadgeBackgroundColor.*#6B7280|#22C55E"
---

<objective>
Establish WXT framework project structure with React, TypeScript, and Tailwind CSS, then implement the background service worker that handles extension icon clicks, manages activation state, updates the icon badge, and triggers user feedback (notifications and sound).

Purpose: Create the foundational cross-browser extension infrastructure and core activation logic that will communicate with the overlay UI built in subsequent plans.

Output: Working WXT project with background script that toggles activation state, updates badge, and sends messages to content scripts (to be created in plan 02).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-&-activation/01-CONTEXT.md
@.planning/phases/01-foundation-&-activation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize WXT project with React and configure build tooling</name>
  <files>
    package.json
    wxt.config.ts
    tsconfig.json
    tailwind.config.ts
    postcss.config.js
  </files>
  <action>
Initialize new WXT project using React TypeScript template, install dependencies, and configure build tooling for cross-browser extension development.

**Initialization:**
```bash
npm create wxt@latest . -- --template react-ts
```

**Install dependencies:**
```bash
npm install webextension-polyfill
npm install -D @types/webextension-polyfill @thedutchcoder/postcss-rem-to-px
npx shadcn@latest init
```

**Configure wxt.config.ts:**
- Add @wxt-dev/module-react to modules array
- Set manifest.name to "Screen Saver"
- Set manifest.permissions: ["storage", "notifications", "activeTab"]
- Configure manifest.action with icon paths (16, 32, 48, 128) and default_title "Toggle Screen Saver"
- **CRITICAL:** Do NOT set default_popup (required for onClicked to fire)

**Configure postcss.config.js:**
- Add @thedutchcoder/postcss-rem-to-px plugin with baseValue: 16
- This converts rem units to px for Shadow DOM compatibility (rem units in Shadow DOM reference host page font-size, breaking layouts)

**Why these tools:**
- WXT: Cross-browser framework with Vite-based builds, auto-imports, HMR for service workers
- webextension-polyfill: Promise-based browser.* API for Firefox/Safari compatibility
- postcss-rem-to-px: Fixes Tailwind rem units inside Shadow DOM contexts
- Shadcn UI: Accessible React components with Tailwind styling

Reference RESEARCH.md sections: Standard Stack, Architecture Patterns (Pattern 1), Common Pitfalls (Pitfall 5)
  </action>
  <verify>
```bash
npm run dev
# Should start WXT dev server without errors
# Should output: "Building Chrome MV3 extension..."
```

Check files exist:
```bash
ls wxt.config.ts tailwind.config.ts postcss.config.js package.json
```
  </verify>
  <done>
- WXT project initialized with React TypeScript template
- Dependencies installed (webextension-polyfill, postcss-rem-to-px, shadcn)
- wxt.config.ts configured with correct manifest permissions and NO default_popup
- postcss.config.js includes rem-to-px conversion with baseValue 16
- Dev server runs without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create background service worker with icon click activation logic</name>
  <files>
    entrypoints/background.ts
    lib/storage.ts
    lib/messages.ts
  </files>
  <action>
Create the background service worker that handles extension icon clicks, manages activation state per tab, updates the icon badge, and provides user feedback via notifications and sound.

**Create lib/messages.ts (message protocol):**
```typescript
export type MessageType = 'ACTIVATE' | 'DEACTIVATE';

export interface ActivateMessage {
  type: 'ACTIVATE';
}

export interface DeactivateMessage {
  type: 'DEACTIVATE';
}

export type Message = ActivateMessage | DeactivateMessage;
```

**Create lib/storage.ts (state management):**
```typescript
// Simple in-memory storage for activation state
// Service workers restart, so use Set to track active tabs
const activeTabs = new Set<number>();

export function getActivationState(tabId: number): boolean {
  return activeTabs.has(tabId);
}

export function setActivationState(tabId: number, active: boolean): void {
  if (active) {
    activeTabs.add(tabId);
  } else {
    activeTabs.delete(tabId);
  }
}

export function clearTabState(tabId: number): void {
  activeTabs.delete(tabId);
}
```

**Create entrypoints/background.ts (service worker):**
Follow RESEARCH.md "Complete Background Script" example with these key requirements:

1. **Import and setup:**
   - Import browser from 'wxt/browser'
   - Import message types from lib/messages
   - Import storage functions from lib/storage

2. **Icon click handler (browser.action.onClicked):**
   - Get current activation state from storage
   - If active: deactivate (send DEACTIVATE message, set gray badge #6B7280, NO notification/sound)
   - If inactive: activate (send ACTIVATE message, set green badge #22C55E, show notification, play sound)

3. **Badge initialization:**
   - On service worker startup, query all active tabs
   - Set initial gray badge (#6B7280) with single space text ' ' for dot appearance

4. **Tab cleanup:**
   - Listen to browser.tabs.onRemoved
   - Clear activation state when tabs close

5. **Notification (activation only):**
   - Use browser.notifications.create with type 'basic'
   - Korean text: title "스크린세이버 활성화", message "ESC 키를 눌러 종료하세요."
   - Icon: browser.runtime.getURL('icon/48.png')

6. **Sound (activation only):**
   - Create new Audio(browser.runtime.getURL('sounds/click.mp3'))
   - Set volume to 0.5
   - Call .play() - handle promise rejection silently (sound is optional enhancement)

**CRITICAL from RESEARCH.md Pitfall 3:**
- Register ALL event listeners at top level of defineBackground main() function
- Do NOT register listeners inside async functions (may miss events during service worker restart)

**Why this approach:**
- In-memory Set for state: Service workers restart frequently, chrome.storage adds latency for simple toggle state
- Badge per tab: Users may have multiple tabs with different activation states
- Silent deactivation: Overlay disappearing is sufficient feedback (per CONTEXT.md decisions)
- Loud activation: Multiple feedback channels ensure user knows screen saver activated (per CONTEXT.md decisions)
  </action>
  <verify>
```bash
# Build extension
npm run build

# Check background script compiled
ls .output/chrome-mv3/background.js

# Check for syntax errors
npm run type-check
```

Code verification:
```bash
# Verify event listeners registered at top level
grep -n "onClicked.addListener" entrypoints/background.ts
grep -n "onRemoved.addListener" entrypoints/background.ts

# Verify badge colors
grep "#6B7280" entrypoints/background.ts  # Gray inactive
grep "#22C55E" entrypoints/background.ts  # Green active

# Verify message sending
grep "sendMessage.*ACTIVATE" entrypoints/background.ts
grep "sendMessage.*DEACTIVATE" entrypoints/background.ts
```
  </verify>
  <done>
- entrypoints/background.ts exists with defineBackground export
- Icon click listener registered at top level (not in async function)
- Badge updates to gray (#6B7280) on deactivate, green (#22C55E) on activate
- Badge text set to single space ' ' for dot appearance
- Notification shown on activation with Korean text
- Sound plays on activation (sounds/click.mp3 at volume 0.5)
- Tab removal listener clears activation state
- Message types defined in lib/messages.ts (ACTIVATE, DEACTIVATE)
- Storage functions in lib/storage.ts manage Set of active tab IDs
- Build completes without errors
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Project structure:**
   ```bash
   ls wxt.config.ts tailwind.config.ts postcss.config.js
   ls entrypoints/background.ts
   ls lib/storage.ts lib/messages.ts
   ```

2. **Build verification:**
   ```bash
   npm run build
   # Should complete without errors
   # Should generate .output/chrome-mv3/ directory
   ```

3. **Type checking:**
   ```bash
   npm run type-check
   # Should pass with no errors
   ```

4. **Configuration correctness:**
   ```bash
   # Verify no default_popup in manifest
   grep -L "default_popup" wxt.config.ts || echo "PASS: No popup configured"

   # Verify rem-to-px plugin
   grep "postcss-rem-to-px" postcss.config.js
   ```
</verification>

<success_criteria>
1. WXT project builds successfully for Chrome, Firefox, Edge, Safari targets
2. Background service worker compiles without type errors
3. wxt.config.ts has correct permissions and NO default_popup (required for onClicked)
4. Event listeners registered at top level in background script
5. Badge API calls use correct colors (gray #6B7280, green #22C55E)
6. Message protocol types defined for ACTIVATE/DEACTIVATE
7. Storage abstraction manages activation state per tab
8. PostCSS configured with rem-to-px conversion for Shadow DOM compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-&-activation/01-01-SUMMARY.md`

Include:
- What was built (WXT project + background service worker)
- Key exports (message types, storage functions)
- Important decisions (in-memory state, per-tab badge, silent deactivation)
- Files created
- Next plan dependency (plan 02 needs message protocol to receive ACTIVATE/DEACTIVATE)
</output>
