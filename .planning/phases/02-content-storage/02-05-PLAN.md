---
phase: 02-content-storage
plan: 05
type: execute
wave: 4
depends_on: ["02-01", "02-02", "02-03", "02-04"]
files_modified:
  - entrypoints/background.ts
  - wxt.config.ts
autonomous: false

must_haves:
  truths:
    - "Default images load into IndexedDB on extension install"
    - "Extension has unlimitedStorage permission for IndexedDB"
    - "Default images are web accessible resources"
    - "User can upload, view, delete, and reorder images in options page"
    - "All Phase 2 requirements (CONT-01 through CONT-06) are fulfilled"
  artifacts:
    - path: "entrypoints/background.ts"
      provides: "onInstalled handler that loads default images"
      contains: "browser.runtime.onInstalled"
      min_lines: 50
    - path: "wxt.config.ts"
      provides: "Manifest with unlimitedStorage and web accessible resources"
      contains: "unlimitedStorage"
  key_links:
    - from: "entrypoints/background.ts"
      to: "lib/defaultImages.ts"
      via: "loadDefaultImages import and call"
      pattern: "import.*loadDefaultImages.*from.*defaultImages"
    - from: "wxt.config.ts"
      to: "manifest.permissions"
      via: "unlimitedStorage permission"
      pattern: "unlimitedStorage"
    - from: "wxt.config.ts"
      to: "manifest.web_accessible_resources"
      via: "images/defaults/*.jpg"
      pattern: "images/defaults/\\*\\.jpg"
---

<objective>
Wire default image loading to background script and update manifest permissions for IndexedDB storage.

Purpose: Complete Phase 2 integration by loading default images on first install and ensuring extension has necessary permissions for unlimited IndexedDB storage. Final human verification confirms all image management features work correctly.

Output: Background script with onInstalled handler, updated manifest with unlimitedStorage permission and web accessible resources, and verified working image management flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-storage/02-RESEARCH.md

# All prior plans in Phase 2
@.planning/phases/02-content-storage/02-01-PLAN.md
@.planning/phases/02-content-storage/02-02-PLAN.md
@.planning/phases/02-content-storage/02-03-PLAN.md
@.planning/phases/02-content-storage/02-04-PLAN.md

# Files to modify
@entrypoints/background.ts
@wxt.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire default image loading to background script with runtime verification</name>
  <files>entrypoints/background.ts</files>
  <action>
Update entrypoints/background.ts to add onInstalled handler that loads default images:

**Add import at top:**
```typescript
import { loadDefaultImages } from '@/lib/defaultImages';
```

**Add onInstalled handler (after existing action.onClicked setup):**
```typescript
// Load default images on first install
browser.runtime.onInstalled.addListener(async (details) => {
  if (details.reason === 'install') {
    console.log('Extension installed - loading default images');
    try {
      await loadDefaultImages();

      // RUNTIME VERIFICATION: Confirm images actually loaded
      const { openDB } = await import('idb');
      const db = await openDB('screen-saver-images', 1);
      const count = await db.count('images');

      if (count === 0) {
        console.error('VERIFICATION FAILED: Default images did not load (count: 0)');
      } else {
        console.log(`Default images loaded successfully (verified: ${count} images in IndexedDB)`);
      }
    } catch (error) {
      console.error('Failed to load default images:', error);
    }
  }

  if (details.reason === 'update') {
    console.log('Extension updated to version', browser.runtime.getManifest().version);
    // No action needed - default images already loaded on install
  }
});
```

**Handler behavior:**
- `reason === 'install'`: First-time install, load all 15 default images
- `reason === 'update'`: Extension update, skip loading (already in IndexedDB)
- **Runtime verification**: After loading, checks IndexedDB count to confirm images actually saved
- Error handling: Log errors but don't block (graceful degradation)

**Critical patterns:**
- Register handler at top level (MV3 service worker compatibility)
- Check details.reason to avoid duplicate loads
- Async/await for IndexedDB operations
- **Verify count after loading** to catch failures early
- Console logging for debugging install flow

**DO NOT:**
- Load defaults on every extension start (only first install)
- Block other initialization on default loading
- Skip error handling (users need to know if defaults fail)
- Skip runtime verification (Task 3 in original plan, now integrated here)

**Preserve existing code:**
- Keep existing action.onClicked handler
- Keep existing message listeners
- Keep existing activation state management
- This is ADDING new functionality, not replacing
  </action>
  <verify>
Type check:
```bash
npm run type-check
```

Build extension:
```bash
npm run build
```

Verify import resolves and handler is registered:
```bash
grep -A10 "onInstalled" entrypoints/background.ts
```

Verify runtime verification code is present:
```bash
grep -A3 "RUNTIME VERIFICATION" entrypoints/background.ts
```
  </verify>
  <done>
- entrypoints/background.ts imports loadDefaultImages from lib/defaultImages.ts
- onInstalled handler added with install/update reason checks
- Handler calls loadDefaultImages() on first install only
- **Runtime verification checks IndexedDB count after loading**
- Logs verification success with count or failure if count === 0
- Error handling and logging in place
- Existing background script functionality preserved
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update manifest with unlimitedStorage and web accessible resources</name>
  <files>wxt.config.ts</files>
  <action>
Update wxt.config.ts to add unlimitedStorage permission and default images as web accessible resources:

**Add to manifest.permissions array:**
```typescript
permissions: [
  'storage',
  'notifications',
  'activeTab',
  'unlimitedStorage',  // NEW: Prevents IndexedDB quota eviction
],
```

**Update manifest.web_accessible_resources (merge with existing sounds):**
```typescript
web_accessible_resources: [
  {
    resources: ['sounds/*.wav'],
    matches: ['<all_urls>'],
  },
  {
    resources: ['images/defaults/*.jpg'],  // NEW: Default images
    matches: ['<all_urls>'],
  },
],
```

**Why unlimitedStorage:**
- Without it: IndexedDB subject to quota limits (10-50% of free disk space)
- With it: No quota-based eviction, only physical disk space limits
- Prevents extension data from being auto-deleted by browser
- Required for storing 15+ images reliably

**Why web_accessible_resources:**
- Default images need to be accessible via browser.runtime.getURL()
- Background script fetches images to load into IndexedDB
- Without this, fetch() fails with permission error

**DO NOT:**
- Remove existing permissions (storage, notifications, activeTab)
- Remove existing web_accessible_resources (sounds/*.wav)
- Skip unlimitedStorage (causes quota errors with many images)
  </action>
  <verify>
Type check:
```bash
npm run type-check
```

Build and verify manifest:
```bash
npm run build
cat .output/chrome-mv3/manifest.json | grep -A2 unlimitedStorage
cat .output/chrome-mv3/manifest.json | grep -A5 web_accessible_resources
```

Ensure both sounds and images are in web_accessible_resources:
```bash
cat .output/chrome-mv3/manifest.json | jq '.web_accessible_resources'
```
  </verify>
  <done>
- wxt.config.ts includes unlimitedStorage in permissions array
- wxt.config.ts includes images/defaults/*.jpg in web_accessible_resources
- Existing permissions and resources preserved
- Generated manifest.json contains both updates
- TypeScript compiles without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete image management system with:
- IndexedDB storage infrastructure (lib/imageStorage.ts, lib/imageProcessing.ts)
- 15 default nature landscape images bundled in public/images/defaults/
- Options page with upload, view, delete, and reorder functionality
- Default image loading on first install via background script with runtime verification
- unlimitedStorage permission for reliable storage
  </what-built>
  <how-to-verify>
**Step 1: Fresh install to test default image loading**
```bash
# Build extension
npm run build

# Load in browser (Chrome/Firefox/Edge)
# Chrome: chrome://extensions -> Load unpacked -> .output/chrome-mv3
# Firefox: about:debugging -> This Firefox -> Load Temporary Add-on -> .output/firefox-mv3/manifest.json
```

**Step 2: Verify default images loaded with runtime verification**
1. Open browser DevTools Console (right-click extension icon -> Inspect service worker / Inspect)
2. Look for log: "Extension installed - loading default images"
3. Look for log: "Loaded default image 1/15" through "15/15"
4. **CRITICAL:** Look for verification log: "Default images loaded successfully (verified: 15 images in IndexedDB)"
5. If verification log shows "count: 0", FAIL - images did not load
6. Right-click extension icon → Options
7. Verify "Your Images (15)" appears in ImageList component
8. Verify 15 default images visible with thumbnails
9. Verify each has visual "DEFAULT" badge overlay on thumbnail

**Step 3: Test image upload**
1. In options page, click "Choose Image" button
2. Select a JPEG/PNG/WebP image from your computer
3. Wait for compression progress indicator
4. Verify success alert shows size comparison (e.g., "3.2MB → 0.4MB")
5. Verify image appears in list below with thumbnail
6. Verify image count increases (e.g., "Your Images (16)")
7. Verify uploaded image does NOT have "DEFAULT" badge

**Step 4: Test image validation**
1. Try uploading a non-image file (e.g., .txt)
2. Verify error alert: "Invalid file type..."
3. Try uploading a very large image (>10MB if available)
4. Verify error alert: "File too large..."

**Step 5: Test drag-and-drop reordering**
1. Hover over drag handle (six dots icon) on any uploaded image
2. Cursor should change to grab cursor
3. Drag image to different position in list
4. Verify image moves visually
5. Refresh page (Cmd+R / Ctrl+R)
6. Verify order persisted (image stayed in new position)

**Step 6: Test delete functionality**
1. Click "Delete" button on an uploaded (non-default) image
2. Verify confirmation dialog appears
3. Click OK, verify image removed from list
4. Try looking for "Delete" button on a default image
5. Verify button is NOT present (defaults protected)

**Step 7: Verify visual distinction of defaults**
1. Scroll through image list
2. Confirm default images have visible blue "DEFAULT" badge on thumbnail
3. Confirm default images have blue ring border around thumbnail
4. Confirm default images have shield icon next to "Bundled image" text
5. Confirm uploaded images have NONE of these visual indicators

**Step 8: Test keyboard navigation (accessibility)**
1. Click on drag handle of any image
2. Press Tab to focus
3. Press Arrow Down/Up keys
4. Verify image moves with keyboard
5. Press Space/Enter to confirm position

**Step 9: Verify no memory leaks**
1. Upload 3-5 images in succession
2. Open browser Task Manager (Chrome: Shift+Esc)
3. Find extension process
4. Verify memory usage is reasonable (<50MB)
5. No continuous memory growth

**Expected outcomes:**
- ✓ Default images load on fresh install
- ✓ Runtime verification confirms 15 images in IndexedDB (console log)
- ✓ 15 default images visible with blue "DEFAULT" badge overlay
- ✓ Default images have visible ring border and shield icon
- ✓ Image upload works with compression and validation
- ✓ Drag-and-drop reordering works (mouse and keyboard)
- ✓ Delete works for uploaded images, button missing for defaults
- ✓ Order persists across page refresh
- ✓ No console errors
- ✓ Memory usage stable

**If any issues found:**
Report specific step that failed, browser used, and console errors if any.
  </how-to-verify>
  <resume-signal>
Type "approved" if all verification steps passed, or describe specific issues found for fixes.
  </resume-signal>
</task>

</tasks>

<verification>
After Task 1-2 automation and human verification checkpoint:
1. Background script has onInstalled handler with loadDefaultImages() call
2. Background script includes runtime verification that checks IndexedDB count
3. Manifest includes unlimitedStorage permission
4. Manifest includes images/defaults/*.jpg in web_accessible_resources
5. Extension installs successfully with 15 default images
6. Runtime verification log confirms images in IndexedDB
7. All image management features work (upload, view, delete, reorder)
8. Default images visually distinguished with badge/border/icon
9. All Phase 2 success criteria validated by human
</verification>

<success_criteria>
Phase 2 complete when human verifies:
- CONT-01: Extension includes 10-20 default nature landscape images ✓
- CONT-02: User can upload custom images via file picker ✓
- CONT-03: Uploaded images stored locally in IndexedDB ✓
- CONT-04: User can view list of all uploaded images ✓
- CONT-05: User can delete uploaded images ✓
- CONT-06: User can reorder images in the collection ✓

All 6 requirements fulfilled and working in actual browser environment.
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-storage/02-05-SUMMARY.md` with:
- Integration complete (background script, manifest updates)
- Runtime verification results from console logs
- Human verification results
- Any issues found and resolved
- Phase 2 success criteria validation status
</output>
