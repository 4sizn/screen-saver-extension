---
phase: 02-content-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/imageStorage.ts
  - lib/imageProcessing.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Extension can save image Blobs to IndexedDB"
    - "Extension can retrieve image Blobs from IndexedDB"
    - "Extension can delete image Blobs from IndexedDB"
    - "Extension can reorder images by updating order field"
    - "Extension validates uploaded images (type, size)"
    - "Extension compresses images to <500KB before storage"
  artifacts:
    - path: "lib/imageStorage.ts"
      provides: "IndexedDB wrapper with image CRUD operations"
      exports: ["saveImage", "getImage", "getAllImages", "deleteImage", "reorderImages"]
      min_lines: 80
    - path: "lib/imageProcessing.ts"
      provides: "Image compression and validation utilities"
      exports: ["compressImage", "validateImageFile", "createObjectURL", "revokeObjectURL"]
      min_lines: 50
  key_links:
    - from: "lib/imageStorage.ts"
      to: "idb library"
      via: "openDB import"
      pattern: "import.*openDB.*from ['\"]idb['\"]"
    - from: "lib/imageProcessing.ts"
      to: "browser-image-compression"
      via: "imageCompression import"
      pattern: "import.*imageCompression.*from ['\"]browser-image-compression['\"]"
---

<objective>
Create IndexedDB storage infrastructure and image processing utilities for local image management.

Purpose: Establish the data layer for storing images as Blobs (not base64 in chrome.storage), with client-side compression to keep storage efficient and loading fast.

Output: Two library modules providing image storage (IndexedDB CRUD) and image processing (compression, validation).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-storage/02-RESEARCH.md

# Prior work from Phase 01
@.planning/phases/01-foundation-&-activation/01-01-SUMMARY.md

# Existing libraries
@lib/storage.ts
@lib/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up IndexedDB storage with idb library</name>
  <files>lib/imageStorage.ts, package.json</files>
  <action>
Install idb library for Promise-based IndexedDB wrapper:
```bash
npm install idb
```

Create lib/imageStorage.ts with IndexedDB schema and CRUD operations:

**Schema:**
- Database name: 'screen-saver-images'
- Version: 1
- Object store: 'images' with keyPath 'id'
- Indexes: 'order' (for sorting), 'isDefault' (for filtering)

**Image object structure:**
```typescript
{
  id: string;           // UUID
  blob: Blob;           // Image binary data
  name: string;         // Original filename
  uploadedAt: number;   // Timestamp
  order: number;        // Display order (0-based)
  isDefault: boolean;   // True for bundled defaults
}
```

**Functions to implement:**
1. `initDB()`: Opens database with schema upgrade logic
2. `saveImage(id, blob, name, isDefault)`: Saves image with auto-assigned order
3. `getImage(id)`: Retrieves single image by ID
4. `getAllImages()`: Returns all images sorted by order index
5. `deleteImage(id)`: Deletes image (throws error if isDefault=true)
6. `reorderImages(imageIds[])`: Updates order field for all images based on array position

**Critical patterns from research:**
- Use TypeScript DBSchema interface for type safety
- Create singleton dbPromise to avoid multiple connections
- Use transactions for multi-step operations (reorderImages)
- Prevent deletion of default images in deleteImage()
- Call initDB() at module load time

**DO NOT:**
- Store images as base64 strings
- Use chrome.storage.local for images
- Allow async operations to lose transaction context
  </action>
  <verify>
Run type check to ensure IndexedDB types are correct:
```bash
npm run type-check
```

Test imports by creating test file:
```typescript
// test.ts
import { saveImage, getAllImages } from './lib/imageStorage';
console.log('Imports work:', typeof saveImage, typeof getAllImages);
```
```bash
npx tsx test.ts && rm test.ts
```
  </verify>
  <done>
- lib/imageStorage.ts exists with 80+ lines
- Exports saveImage, getImage, getAllImages, deleteImage, reorderImages functions
- Uses idb library with TypeScript DBSchema interface
- No TypeScript errors in type-check
- Module can be imported without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create image processing utilities</name>
  <files>lib/imageProcessing.ts, package.json</files>
  <action>
Install browser-image-compression library:
```bash
npm install browser-image-compression
```

Create lib/imageProcessing.ts with compression and validation functions:

**Functions to implement:**

1. **compressImage(file: File): Promise&lt;Blob&gt;**
   - Uses browser-image-compression library
   - Target: 1920x1080 max dimensions
   - Quality: 0.85 (good balance)
   - Max size: 500KB (0.5MB)
   - Format: JPEG (universal support)
   - Enable Web Worker for non-blocking compression
   - Returns compressed Blob ready for IndexedDB storage

2. **validateImageFile(file: File): { valid: boolean; error?: string }**
   - Check MIME type: must be image/jpeg, image/jpg, image/png, or image/webp
   - Check file size: must be < 10MB (before compression)
   - Return validation object with error message if invalid

3. **createObjectURL(blob: Blob): string**
   - Wrapper around URL.createObjectURL for previews
   - Returns blob: URL string

4. **revokeObjectURL(url: string): void**
   - Wrapper around URL.revokeObjectURL for cleanup
   - Call in component cleanup to prevent memory leaks

**Compression options (from research):**
```typescript
{
  maxSizeMB: 0.5,              // 500KB target
  maxWidthOrHeight: 1920,      // Full HD
  useWebWorker: true,          // Non-blocking
  fileType: 'image/jpeg',      // Universal format
  initialQuality: 0.85,        // Good quality
}
```

**Validation rules:**
- Accept: image/jpeg, image/jpg, image/png, image/webp
- Reject: files > 10MB (unreasonable even before compression)
- Provide clear error messages for users

**DO NOT:**
- Use Canvas API manually (library handles it better)
- Skip validation (security risk)
- Allow unlimited file sizes
  </action>
  <verify>
Run type check:
```bash
npm run type-check
```

Test compression with a dummy test:
```typescript
// test.ts
import { validateImageFile } from './lib/imageProcessing';
const mockFile = new File(['test'], 'test.jpg', { type: 'image/jpeg' });
const result = validateImageFile(mockFile);
console.log('Validation works:', result.valid === true);
```
```bash
npx tsx test.ts && rm test.ts
```
  </verify>
  <done>
- lib/imageProcessing.ts exists with 50+ lines
- Exports compressImage, validateImageFile, createObjectURL, revokeObjectURL
- Uses browser-image-compression library
- Validation checks MIME type and file size
- Compression targets 500KB, 1920x1080, JPEG format
- No TypeScript errors
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Both library files exist and export expected functions
2. Type checking passes without errors
3. Dependencies (idb, browser-image-compression) installed in package.json
4. Code follows patterns from existing lib/ modules (storage.ts, messages.ts)
</verification>

<success_criteria>
- IndexedDB storage layer ready for image CRUD operations
- Image processing utilities ready for upload flow
- No external API calls (all client-side)
- Foundation in place for Wave 2 (default images) and Wave 3 (UI components)
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-storage/02-01-SUMMARY.md` with:
- Tech added (idb, browser-image-compression)
- Key files created
- Patterns established (IndexedDB schema, compression settings)
- Any decisions made during implementation
</output>
