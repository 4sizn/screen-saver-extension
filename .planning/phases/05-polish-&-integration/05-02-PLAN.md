---
phase: 05-polish-&-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Production build completes successfully without errors"
    - "All activation and deactivation flows work correctly in production mode"
    - "Image display renders with both fit modes (cover/contain)"
    - "Settings persist correctly and take effect immediately"
    - "Default images appear immediately on fresh install"
  artifacts:
    - path: ".output/chrome-mv3/"
      provides: "Production build output directory"
      contains: "manifest.json"
    - path: ".output/chrome-mv3/manifest.json"
      provides: "Generated manifest with all permissions and web accessible resources"
      contains: "manifest_version"
  key_links:
    - from: "Production build"
      to: "Fresh install test"
      via: "Load unpacked extension from .output/chrome-mv3/"
      pattern: "chrome://extensions.*Load unpacked"
    - from: "Default images"
      to: "IndexedDB verification"
      via: "DevTools Application tab shows 15 default images"
      pattern: "screen-saver-images.*images.*15"
---

<objective>
Build production version of extension and verify all functionality works correctly before browser-specific package generation.

Purpose: Catch production-specific issues (minification, CSP, resource loading) that may not appear in development mode before creating distribution packages.

Output: Verified production build ready for browser-specific packaging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-&-integration/05-RESEARCH.md
@.planning/phases/05-polish-&-integration/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build production version and verify output</name>
  <files>.output/chrome-mv3/</files>
  <action>
Build production version of extension and verify build artifacts are correct.

Build command:
```bash
npm run build
```

This runs WXT's production build which:
- Minifies JavaScript/TypeScript
- Optimizes assets
- Generates manifest.json
- Bundles all entrypoints (background, content, options)
- Copies web accessible resources (images, sounds)

Verification steps:
1. Build completes without TypeScript errors
2. Output directory exists: .output/chrome-mv3/
3. Core files present:
   - manifest.json (generated manifest)
   - background.js (service worker)
   - content-scripts/content.js (content script)
   - options.html (options page)
4. Web accessible resources copied:
   - images/defaults/ (15 Unsplash images from 05-01)
   - icon/ (extension icons)
   - sounds/ removed (audio playback removed in 05-01)
5. Manifest permissions correct:
   - storage (IndexedDB)
   - notifications (activation feedback)
   - activeTab (content script injection)
   - unlimitedStorage (prevent quota eviction)

Check manifest.json content:
```bash
cat .output/chrome-mv3/manifest.json
```

Verify:
- manifest_version: 3
- name: Screen Saver (or configured name)
- version: matches package.json
- permissions: ["storage", "notifications", "activeTab", "unlimitedStorage"]
- action: { default_icon: ... }
- background: { service_worker: "background.js", type: "module" }
- web_accessible_resources: includes images/defaults/*

Build output size check:
```bash
du -sh .output/chrome-mv3/
# Should be reasonable (<50MB total including images)
```
  </action>
  <verify>
```bash
# Verify build succeeded
npm run build
echo $?  # Should be 0 (success)

# Check output exists
ls -la .output/chrome-mv3/manifest.json
ls -la .output/chrome-mv3/background.js
ls -la .output/chrome-mv3/content-scripts/
ls -la .output/chrome-mv3/options.html

# Verify default images copied
ls public/images/defaults/ | wc -l  # Should be 15
ls .output/chrome-mv3/images/defaults/ | wc -l  # Should be 15

# Check manifest structure
cat .output/chrome-mv3/manifest.json | grep -E "(manifest_version|permissions|background)"
```
  </verify>
  <done>Production build completes successfully, all core files and resources present in .output/chrome-mv3/, manifest.json contains correct permissions and structure</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete production build of Screen Saver extension with:
- Minified background service worker and content script
- Bundled options page with image management UI
- 15 Unsplash nature landscape default images
- Settings infrastructure (fit mode, color picker, image enable/disable)
- Full activation/deactivation flow without audio
  </what-built>
  <how-to-verify>
**Test in production mode (NOT npm run dev):**

1. **Fresh Install Test:**
   ```bash
   # Build if not already done
   npm run build

   # Open Chrome
   # Navigate to chrome://extensions/
   # Enable "Developer mode" (top right)
   # Click "Load unpacked"
   # Select: .output/chrome-mv3/
   ```

2. **Verify Installation:**
   - [ ] Extension appears in extensions list
   - [ ] Extension icon visible in toolbar
   - [ ] Badge shows gray (inactive state)
   - [ ] No console errors in extension service worker (click "service worker" link)

3. **Verify Default Images Loaded:**
   - [ ] Open DevTools (F12)
   - [ ] Go to Application tab > IndexedDB > screen-saver-images > images
   - [ ] Should see 15 entries with isDefault: true
   - [ ] Each entry has blob data, name "Default Nature N", orderIndex 0-14

4. **Test Activation Flow:**
   - [ ] Navigate to any web page (e.g., https://example.com)
   - [ ] Click extension icon
   - [ ] Full-screen overlay appears immediately
   - [ ] Random nature image displayed
   - [ ] Badge turns green
   - [ ] Notification appears (Korean text: "스크린세이버 활성화")
   - [ ] NO console errors about audio/autoplay
   - [ ] Image displays correctly (no broken image icon)

5. **Test Deactivation Flow:**
   - [ ] Press ESC key → Overlay disappears, badge turns gray
   - [ ] Click icon again to activate → Works
   - [ ] Click icon again to deactivate → Overlay disappears
   - [ ] Badge state correct (gray when inactive, green when active)

6. **Test Image Management (Options Page):**
   ```bash
   # Right-click extension icon > Options
   # OR navigate to chrome://extensions/ and click "Extension options"
   ```
   - [ ] Options page opens in new tab
   - [ ] 15 default images visible in list with thumbnails
   - [ ] Default badge overlay visible on all images
   - [ ] Upload new image → Works, image appears in list
   - [ ] Enable/disable toggle → Works, UI updates
   - [ ] Drag to reorder → Works (optional, verify if time allows)
   - [ ] Delete custom image → Works
   - [ ] Cannot delete default images (delete button disabled/missing)

7. **Test Display Settings:**
   - [ ] Change fit mode: Cover → Contain
   - [ ] Change background color (use color picker)
   - [ ] Activate screen saver → Settings take effect
   - [ ] Image displays with correct fit mode
   - [ ] Background color visible in contain mode (if image has letterboxing)
   - [ ] Close options page, reopen → Settings persisted

8. **Test Edge Cases:**
   - [ ] Multiple tabs: Activate in Tab A, switch to Tab B → Tab A overlay persists
   - [ ] Multiple tabs: Activate in Tab B while Tab A active → Both work independently
   - [ ] Badge state per-tab: Each tab shows correct state (gray vs green)
   - [ ] Disable all custom images, activate → Default images still work
   - [ ] Service worker restart test:
     - Activate screen saver
     - Wait 2 minutes (service worker terminates)
     - Click icon → Should deactivate correctly
     - Badge state correct after service worker restart

9. **Performance Check:**
   - [ ] Open Chrome Task Manager (Shift+Esc)
   - [ ] Find "Extension: Screen Saver"
   - [ ] Memory footprint: Should be <15MB
   - [ ] CPU usage: Should be 0% when inactive
   - [ ] Activate screen saver, check Memory again: Should not spike significantly

10. **Console Error Check:**
    - [ ] No errors in main page console (F12 on web page)
    - [ ] No errors in extension service worker console (chrome://extensions/ → "service worker")
    - [ ] No errors in options page console (F12 on options page)
    - [ ] Specifically confirm NO "NotAllowedError" audio errors

**Expected Results:**
- All tests pass without critical errors
- Extension behaves identically to development mode
- No minification-related breakage
- No CSP violations
- No resource loading failures
- Production build is stable and ready for distribution

**If Issues Found:**
Report specific failures with:
- Which test step failed
- Browser console errors (copy exact error messages)
- Screenshots if visual issues
- Behavior observed vs expected

**Common Production-Only Issues to Watch For:**
- Images fail to load (broken image icons) → web_accessible_resources issue
- Settings don't save → chrome.storage permissions issue
- Overlay doesn't appear → content script injection failure
- Default images don't load → IndexedDB or fetch() issue in minified code
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe specific issues encountered for troubleshooting.

If approved: Ready to proceed to Wave 3 (Distribution Preparation).
If issues found: Will fix issues before continuing.
  </resume-signal>
</task>

</tasks>

<verification>
**Production Build Checklist:**
- [ ] `npm run build` succeeds without errors
- [ ] .output/chrome-mv3/ directory contains all expected files
- [ ] manifest.json has correct structure and permissions
- [ ] Extension loads in browser without manifest errors
- [ ] All Phase 1-4 functionality works in production mode
- [ ] No console errors related to minification or CSP
- [ ] Performance metrics acceptable (Memory <15MB, CPU 0% idle)
</verification>

<success_criteria>
**Measurable Completion:**
- [ ] Production build exists in .output/chrome-mv3/
- [ ] Extension loads successfully via "Load unpacked"
- [ ] All 15 default images appear in IndexedDB on fresh install
- [ ] Activation/deactivation flows work without errors
- [ ] Image management UI fully functional in production
- [ ] Settings persist and take effect correctly
- [ ] No audio autoplay errors in console
- [ ] User approves production build as stable and ready for distribution
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-&-integration/05-02-SUMMARY.md` following the standard summary template.

Include:
- Production build verification results
- Any issues discovered and fixed
- Performance metrics (memory, CPU)
- User approval timestamp
- Notes on production vs development differences (if any)
</output>
