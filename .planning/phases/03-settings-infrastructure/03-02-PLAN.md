---
phase: 03-settings-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - package.json
  - components/ui/switch.tsx
  - components/ui/label.tsx
  - entrypoints/options/components/DisplaySettings.tsx
  - entrypoints/options/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can select cover or contain fit mode"
    - "User can choose background color via color picker"
    - "Settings save automatically without Save button"
  artifacts:
    - path: "entrypoints/options/components/DisplaySettings.tsx"
      provides: "Display settings UI with fit selector and color picker"
      min_lines: 80
    - path: "components/ui/switch.tsx"
      provides: "Shadcn Switch component for toggles"
      min_lines: 30
    - path: "components/ui/label.tsx"
      provides: "Shadcn Label component for form labels"
      min_lines: 15
  key_links:
    - from: "DisplaySettings.tsx"
      to: "lib/settingsStorage.ts"
      via: "displaySettings.getValue and setValue"
      pattern: "displaySettings\\.(getValue|setValue)"
    - from: "DisplaySettings.tsx"
      to: "react-colorful"
      via: "HexColorPicker component import"
      pattern: "import.*HexColorPicker.*react-colorful"
---

<objective>
Create display settings UI for configuring image fit mode and background color.

Purpose: Allow users to control how images render in full-screen overlay (cover vs contain) and what color appears in letterbox areas or behind transparent images. Settings auto-save to chrome.storage.sync without requiring Save button.

Output: DisplaySettings component with fit selector (radio buttons or dropdown) and color picker (react-colorful), integrated into options page.
</objective>

<execution_context>
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/PROJECT.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/ROADMAP.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/STATE.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/phases/03-settings-infrastructure/03-CONTEXT.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/phases/03-settings-infrastructure/03-RESEARCH.md

## Prior Phase Context

From Phase 2 (02-02):
- Shadcn UI foundation already established (Button, Card components)
- cn() utility in lib/utils.ts for className merging
- forwardRef pattern for all components

From Phase 3 Plan 1:
- DisplaySettings interface and displaySettings storage defined in lib/settingsStorage.ts
- imageFit: 'cover' | 'contain'
- backgroundColor: string (hex format)

## Current Files

@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/entrypoints/options/App.tsx
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-colorful and Shadcn Switch/Label components</name>
  <files>package.json, components/ui/switch.tsx, components/ui/label.tsx</files>
  <action>
**Install dependencies:**
```bash
npm install react-colorful
npx shadcn@latest add switch
npx shadcn@latest add label
```

**Expected outcome:**
- react-colorful added to package.json dependencies
- components/ui/switch.tsx created with Radix UI Switch primitive
- components/ui/label.tsx created with Radix UI Label primitive
- Switch component provides accessible role="switch" with keyboard interaction
- Label component provides accessible htmlFor association

**Why these tools:**
- react-colorful: 2.8KB gzipped, no CSS import needed, accessible keyboard navigation, TypeScript native
- Shadcn Switch: Radix UI primitive with ARIA role, Space to toggle, focus management
- Shadcn Label: Proper htmlFor association for screen readers and click targets

**Note on Shadcn CLI:**
The `npx shadcn@latest add` command will create properly configured components. Accept defaults if prompted. If components already exist (unlikely but possible), skip and use existing.
  </action>
  <verify>
cat package.json | grep react-colorful
ls components/ui/switch.tsx components/ui/label.tsx
npm run type-check
  </verify>
  <done>
- react-colorful in package.json dependencies
- components/ui/switch.tsx exists and exports Switch component
- components/ui/label.tsx exists and exports Label component
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DisplaySettings component with fit selector and color picker</name>
  <files>entrypoints/options/components/DisplaySettings.tsx, entrypoints/options/App.tsx</files>
  <action>
**Create entrypoints/options/components/DisplaySettings.tsx:**

```typescript
import { useState, useEffect } from 'react';
import { HexColorPicker } from 'react-colorful';
import { Label } from '@/components/ui/label';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { displaySettings } from '@/lib/settingsStorage';
import type { DisplaySettings as DisplaySettingsType } from '@/lib/settingsStorage';

export function DisplaySettings() {
  const [settings, setSettings] = useState<DisplaySettingsType>({
    imageFit: 'cover',
    backgroundColor: '#000000',
  });

  const [colorInput, setColorInput] = useState('#000000');

  // Load settings on mount
  useEffect(() => {
    displaySettings.getValue().then((saved) => {
      if (saved) {
        setSettings(saved);
        setColorInput(saved.backgroundColor);
      }
    });
  }, []);

  // Auto-save imageFit changes immediately
  const handleFitChange = async (fit: 'cover' | 'contain') => {
    const newSettings = { ...settings, imageFit: fit };
    setSettings(newSettings);
    await displaySettings.setValue(newSettings);
  };

  // Debounced auto-save for color changes (avoid excessive writes during drag)
  useEffect(() => {
    const timer = setTimeout(async () => {
      if (colorInput !== settings.backgroundColor) {
        const newSettings = { ...settings, backgroundColor: colorInput };
        setSettings(newSettings);
        await displaySettings.setValue(newSettings);
      }
    }, 300); // 300ms debounce

    return () => clearTimeout(timer);
  }, [colorInput, settings]);

  return (
    <Card className="mb-6">
      <CardHeader>
        <CardTitle>Display Settings</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Image Fit Selector */}
        <div>
          <Label className="text-base font-medium mb-3 block">Image Fit</Label>
          <div className="space-y-2">
            <label className="flex items-center space-x-3 cursor-pointer">
              <input
                type="radio"
                name="imageFit"
                value="cover"
                checked={settings.imageFit === 'cover'}
                onChange={() => handleFitChange('cover')}
                className="w-4 h-4 text-blue-600"
              />
              <div>
                <div className="font-medium">Cover</div>
                <div className="text-sm text-gray-600">
                  Crop image to fill screen (no letterbox)
                </div>
              </div>
            </label>
            <label className="flex items-center space-x-3 cursor-pointer">
              <input
                type="radio"
                name="imageFit"
                value="contain"
                checked={settings.imageFit === 'contain'}
                onChange={() => handleFitChange('contain')}
                className="w-4 h-4 text-blue-600"
              />
              <div>
                <div className="font-medium">Contain</div>
                <div className="text-sm text-gray-600">
                  Show full image with letterbox bars if needed
                </div>
              </div>
            </label>
          </div>
        </div>

        {/* Background Color Picker */}
        <div>
          <Label className="text-base font-medium mb-3 block">
            Background Color
          </Label>
          <p className="text-sm text-gray-600 mb-3">
            Appears in letterbox areas (contain mode) or behind transparent images
          </p>
          <div className="space-y-3">
            <HexColorPicker color={colorInput} onChange={setColorInput} />
            <input
              type="text"
              value={colorInput}
              onChange={(e) => setColorInput(e.target.value)}
              className="font-mono text-sm border border-gray-300 rounded px-3 py-2 w-32"
              pattern="^#[0-9A-Fa-f]{6}$"
              placeholder="#000000"
            />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

export default DisplaySettings;
```

**Update entrypoints/options/App.tsx:**

Import DisplaySettings component and add it AFTER the header but BEFORE ImageUpload:

```typescript
import DisplaySettings from './components/DisplaySettings';

// In the JSX:
<main>
  <DisplaySettings />
  <ImageUpload />
  <ImageList />
</main>
```

**Why this structure:**
- Radio buttons (not dropdown) for fit mode: Only 2 options, visual descriptions help user understand difference
- Inline color picker (not popover): Always visible, no click-to-open friction
- Debounced color auto-save: Prevents excessive chrome.storage writes during drag (60+ per second → 1 per 300ms pause)
- Immediate fit auto-save: No drag interaction, instant feedback expected
- Help text explains when background shows: Prevents "setting doesn't work" confusion
- Controlled components with useState: Predictable state, no uncontrolled → controlled warning
- Card component: Visual consistency with existing ImageUpload/ImageList sections
  </action>
  <verify>
npm run type-check
npm run dev
# Manually check in browser:
# 1. Open extension options page
# 2. Verify DisplaySettings section appears above image upload
# 3. Toggle fit options - radio selection works
# 4. Drag color picker - hex input updates in real-time
# 5. Check DevTools Application > Storage > chrome.storage > Sync - displaySettings key exists with current values
  </verify>
  <done>
- DisplaySettings component renders in options page
- Fit selector shows cover/contain radio buttons with descriptions
- Color picker updates colorInput state in real-time
- Settings auto-save to chrome.storage.sync (verified in DevTools)
- No "uncontrolled to controlled" React warnings
- TypeScript compilation succeeds
  </done>
</task>

</tasks>

<verification>
**Functional verification:**
1. Options page shows DisplaySettings section before image management
2. Fit selector defaults to "cover" on first load
3. Color picker defaults to black (#000000)
4. Changing fit option updates immediately (check DevTools storage)
5. Dragging color picker shows live preview, saves after 300ms pause
6. Typing in hex input updates picker and saves
7. Settings persist after browser restart

**Visual verification:**
- Card component styling matches ImageUpload/ImageList
- Radio buttons are large enough for easy clicking
- Color picker has reasonable size (~150-200px)
- Help text is subtle but readable

**Type safety:**
- npm run type-check passes
- DisplaySettings import from lib/settingsStorage works
- HexColorPicker import from react-colorful works
</verification>

<success_criteria>
- User can select cover or contain fit mode via radio buttons
- User can pick background color via HexColorPicker
- Settings auto-save without Save button
- Settings persist across browser restart
- UI integrates cleanly into existing options page
- No TypeScript or React warnings
- Requirements SET-03 and SET-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-infrastructure/03-02-SUMMARY.md`
</output>
