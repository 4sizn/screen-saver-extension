---
phase: 03-settings-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/imageStorage.ts
  - lib/settingsStorage.ts
autonomous: true

must_haves:
  truths:
    - "Settings persist across browser restart"
    - "Existing images default to enabled state after migration"
    - "Display settings have sensible defaults (cover fit, black background)"
  artifacts:
    - path: "lib/imageStorage.ts"
      provides: "IndexedDB v2 schema with isEnabled field and migration"
      min_lines: 200
      exports: ["ImageRecord", "initDB", "toggleImageEnabled"]
    - path: "lib/settingsStorage.ts"
      provides: "WXT storage definition for display settings"
      min_lines: 20
      exports: ["DisplaySettings", "displaySettings"]
  key_links:
    - from: "lib/imageStorage.ts"
      to: "IndexedDB v2"
      via: "onupgradeneeded migration cursor"
      pattern: "onupgradeneeded.*oldVersion < 2"
    - from: "lib/settingsStorage.ts"
      to: "chrome.storage.sync"
      via: "WXT storage.defineItem"
      pattern: "storage\\.defineItem.*sync:displaySettings"
---

<objective>
Create persistent settings storage infrastructure for screen saver configuration.

Purpose: Establish backend storage layer for both per-image settings (enable/disable toggles) and global display preferences (fit mode and background color). Settings must survive browser restarts and extension updates.

Output: IndexedDB schema v2 with isEnabled field, WXT storage definition for display settings, migration logic for existing images.
</objective>

<execution_context>
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/PROJECT.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/ROADMAP.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/STATE.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/phases/03-settings-infrastructure/03-CONTEXT.md
@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/.planning/phases/03-settings-infrastructure/03-RESEARCH.md

## Prior Phase Context

From Phase 2 (02-01):
- IndexedDB v1 schema already exists with native API (no idb library - service worker compatibility)
- ImageRecord interface: id, blob, name, uploadedAt, order, isDefault
- Singleton dbPromise pattern prevents multiple connections
- Current DB_VERSION = 1

From Phase 2 (02-02):
- WXT framework already in use
- storage from 'wxt/storage' available for cross-browser storage abstraction

## Current Files

@/Users/hsshin-rsupport/Documents/lotus/screen-saver-web/lib/imageStorage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate IndexedDB to version 2 with isEnabled field</name>
  <files>lib/imageStorage.ts</files>
  <action>
Update IndexedDB schema from version 1 to version 2, adding isEnabled boolean field to ImageRecord interface.

**Update ImageRecord interface:**
```typescript
export interface ImageRecord {
  id: string;
  blob: Blob;
  name: string;
  uploadedAt: number;
  order: number;
  isDefault: boolean;
  isEnabled: boolean; // NEW: Controls image rotation inclusion
}
```

**Update DB_VERSION:**
Change `const DB_VERSION = 1;` to `const DB_VERSION = 2;`

**Add migration logic in initDB onupgradeneeded:**
After the existing version 1 setup (lines 31-39), add version 2 migration:

```typescript
// Version 2: Add isEnabled field to existing images
if (event.oldVersion < 2) {
  const store = tx.objectStore(STORE_NAME);

  // Migrate existing records to have isEnabled: true (default all images to enabled)
  store.openCursor().onsuccess = (e) => {
    const cursor = (e.target as IDBRequest<IDBCursorWithValue>).result;
    if (cursor) {
      const record = cursor.value;
      if (record.isEnabled === undefined) {
        record.isEnabled = true;
        cursor.update(record);
      }
      cursor.continue();
    }
  };
}
```

**Update saveImage function:**
Add isEnabled to default parameters and imageRecord creation:
```typescript
export async function saveImage(
  id: string,
  blob: Blob,
  name: string,
  isDefault = false,
  isEnabled = true // NEW: Default new images to enabled
): Promise<void> {
  // ... existing code ...
  const imageRecord: ImageRecord = {
    id,
    blob,
    name,
    uploadedAt: Date.now(),
    order,
    isDefault,
    isEnabled, // NEW
  };
  // ... rest of function ...
}
```

**Add toggleImageEnabled function:**
```typescript
/**
 * Toggle image enabled state for rotation inclusion
 * @param id - Image identifier
 */
export async function toggleImageEnabled(id: string): Promise<void> {
  const db = await initDB();
  const tx = db.transaction(STORE_NAME, 'readwrite');
  const store = tx.objectStore(STORE_NAME);

  const image = await new Promise<ImageRecord>((resolve, reject) => {
    const request = store.get(id);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });

  if (image) {
    image.isEnabled = !image.isEnabled;
    await new Promise<void>((resolve, reject) => {
      const request = store.put(image);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }
}
```

**Why this approach:**
- Native IndexedDB cursor for migration (no libraries available in service worker context)
- Default existing images to enabled (preserves current behavior - all images visible)
- Version check pattern allows future migrations without breaking v1 â†’ v2 upgrade
- No index on isEnabled (boolean indexes are inefficient in IndexedDB - filter in-memory instead)
  </action>
  <verify>npm run type-check</verify>
  <done>
- ImageRecord interface includes isEnabled: boolean
- DB_VERSION = 2
- Migration code exists in onupgradeneeded for oldVersion < 2
- toggleImageEnabled function exported and type-checks
- saveImage signature includes isEnabled parameter with default true
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WXT storage definition for display settings</name>
  <files>lib/settingsStorage.ts</files>
  <action>
Create new file `lib/settingsStorage.ts` with WXT storage.defineItem for chrome.storage.sync-backed display settings.

**Full file content:**
```typescript
import { storage } from 'wxt/storage';

/**
 * Display settings for screen saver rendering
 */
export interface DisplaySettings {
  imageFit: 'cover' | 'contain';
  backgroundColor: string; // Hex format: '#000000'
}

/**
 * Persistent display settings stored in chrome.storage.sync
 * Automatically syncs across devices and browser sessions
 */
export const displaySettings = storage.defineItem<DisplaySettings>(
  'sync:displaySettings',
  {
    fallback: {
      imageFit: 'cover',
      backgroundColor: '#000000',
    },
  }
);
```

**Why this approach:**
- WXT storage.defineItem provides type-safe chrome.storage.sync wrapper
- `sync:` prefix tells WXT to use chrome.storage.sync (cross-device sync)
- Fallback ensures settings always have default values (prevents undefined state)
- cover = crop to fill, contain = letterbox to fit (standard CSS object-fit values)
- Black background (#000000) is neutral default for letterboxing
- Small data size (~50 bytes) well within chrome.storage.sync 8KB item limit
- No need for storage.watch in this plan - Phase 4 will consume these settings
  </action>
  <verify>npm run type-check</verify>
  <done>
- lib/settingsStorage.ts exists
- Exports DisplaySettings interface with imageFit and backgroundColor
- Exports displaySettings storage item with sync prefix
- Fallback defaults to cover fit and black background
- TypeScript compilation succeeds
  </done>
</task>

</tasks>

<verification>
**Type safety:**
- `npm run type-check` passes without errors
- ImageRecord interface includes isEnabled field
- DisplaySettings interface correctly typed

**Migration verification:**
To verify migration works, could manually test by:
1. Load extension with DB v1 (has existing images)
2. Update code to v2 and reload
3. Check IndexedDB in DevTools - all images should have isEnabled: true

However, this is not required for plan completion - migration code follows MDN documented pattern.

**Storage verification:**
displaySettings can be tested in Phase 3 Plan 2 when UI consumes it.
</verification>

<success_criteria>
- IndexedDB schema migrated to version 2
- ImageRecord interface includes isEnabled field
- Existing images default to enabled during migration
- toggleImageEnabled function available for UI integration
- displaySettings storage defined with WXT
- Default values sensible (cover, black)
- TypeScript type-checking passes
- No runtime errors from schema changes
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-infrastructure/03-01-SUMMARY.md`
</output>
